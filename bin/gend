#!/bin/env perl

use File::Basename 'basename', 'dirname';

my $file = $ARGV[0];
(my $base = $file) =~ s{^.*/|\.[^.]+$}{}g;
open(FH, "< $file");
while (<FH>) {
	s/%.*$//;
	if (s/^\@import://) {
		s/^\s*//;
		s/\s*$//;
		my @saty_list = ("$_.saty", "$_.satyh");
		foreach my $f (@saty_list) {
			if (-e $f) {
				print "$rule:\t$f\n";
			}
		}
	} else {
		while (s/[A-Za-z0-9_\-][A-Za-z0-9_\-\.\/]*\.(bmp|jpg|pdf|txt|saty|tex|eps)//) {
			print "DEPS_$base+=$&\n";
			s{^.*/|\.[^.]+$}{}g;
			print "DEPS_$base+=\$(DEPS_$&)\n";
			print "REFS_$&+=$base\n";
		}
	}
}
close FH;
